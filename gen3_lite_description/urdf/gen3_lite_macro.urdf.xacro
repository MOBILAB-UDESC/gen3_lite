<?xml version="1.0"?>

<robot xmlns:xacro="http://ros.org/wiki/xacro">

    <xacro:include filename="$(find gen3_lite_description)/urdf/macros.urdf.xacro" />

    <!-- Propagate last link name information because it is the gripper's parent link -->
    <xacro:property name="last_arm_link" value="dummy_link" />

    <xacro:macro name="load_arm" params="*origin parent prefix sim_gazebo gripper use_camera">
        <joint name="${prefix}base_joint" type="fixed">
            <xacro:insert_block name="origin" />
            <parent link="${parent}" />
            <child link="${prefix}base_link" />
        </joint>
        <link name="${prefix}base_link">
            <inertial>
                <origin rpy="0 0 0" xyz="0.00244324 0.00015573 0.08616742" />
                <mass value="1.14608471" />
                <inertia
                    ixx="0.00335854" ixy="3.9E-07" ixz="0.00010989"
                    iyy="0.003311" iyz="1.91E-06"
                    izz="0.00077158" />
            </inertial>
            <visual>
                <origin rpy="0 0 0" xyz="0 0 0" />
                <geometry>
                    <mesh filename="package://gen3_lite_description/meshes/base_link.STL" />
                </geometry>
                <material name="gen3_lite_white" />
            </visual>
            <collision>
                <origin rpy="0 0 0" xyz="0 0 0" />
                <geometry>
                    <mesh filename="package://gen3_lite_description/meshes/base_link.STL" />
                </geometry>
            </collision>
        </link>

        <link name="${prefix}shoulder_link">
            <inertial>
                <origin rpy="0 0 0" xyz="2.477E-05 0.02213531 0.09937686" />
                <mass value="0.95974404" />
                <inertia
                    ixx="0.00165947" ixy="2E-08" ixz="3.6E-07"
                    iyy="0.00140355" iyz="0.00034927"
                    izz="0.00089493" />
            </inertial>
            <visual>
                <origin xyz="0 0 0" rpy="0 0 0" />
                <geometry>
                    <mesh filename="package://gen3_lite_description/meshes/shoulder_link.STL" />
                </geometry>
                <material name="gen3_lite_white" />
            </visual>
            <collision>
                <origin rpy="0 0 0" xyz="0 0 0" />
                <geometry>
                    <mesh filename="package://gen3_lite_description/meshes/shoulder_link.STL" />
                </geometry>
            </collision>
        </link>
        <joint name="${prefix}joint_1" type="revolute">
            <origin rpy="0 0 0" xyz="0 0 0.12825" />
            <parent link="${prefix}base_link" />
            <child link="${prefix}shoulder_link" />
            <axis xyz="0 0 1" />
            <limit lower="${min_joint_1_pos}" upper="${max_joint_1_pos}"
                    effort="${joint_1_effort}" velocity="${joint_1_vel}" />
        </joint>

        <link name="${prefix}arm_link">
            <inertial>
                <origin rpy="0 0 0" xyz="0.02998299 0.21154808 0.0453031" />
                <mass value="1.17756164" />
                <inertia
                    ixx="0.01149277" ixy="1E-06" ixz="1.6E-07"
                    iyy="0.00102851" iyz="0.00140765"
                    izz="0.01133492" />
            </inertial>
            <visual>
                <origin rpy="0 0 0" xyz="0 0 0" />
                <geometry>
                    <mesh filename="package://gen3_lite_description/meshes/arm_link.STL" />
                </geometry>
                <material name="gen3_lite_white" />
            </visual>
            <collision>
                <origin rpy="0 0 0" xyz="0 0 0" />
                <geometry>
                    <mesh filename="package://gen3_lite_description/meshes/arm_link.STL" />
                </geometry>
            </collision>
        </link>
        <joint name="${prefix}joint_2" type="revolute">
            <origin rpy="1.5708 0 0" xyz="0 -0.03 0.115" />
            <parent link="${prefix}shoulder_link" />
            <child link="${prefix}arm_link" />
            <axis xyz="0 0 1" />
            <limit lower="${min_joint_2_pos}" upper="${max_joint_2_pos}"
                    effort="${joint_2_effort}" velocity="${joint_2_vel}" />
        </joint>

        <link name="${prefix}forearm_link">
            <inertial>
                <origin rpy="0 0 0" xyz="0.0301559 0.09502206 0.0073555" />
                <mass value="0.59767669" />
                <inertia
                    ixx="0.00163256" ixy="7.11E-06" ixz="1.54E-06"
                    iyy="0.00029798" iyz="9.587E-05"
                    izz="0.00169091" />
            </inertial>
            <visual>
                <origin rpy="0 0 0" xyz="0 0 0" />
                <geometry>
                    <mesh filename="package://gen3_lite_description/meshes/forearm_link.STL" />
                </geometry>
                <material name="gen3_lite_white" />
            </visual>
            <collision>
                <origin rpy="0 0 0" xyz="0 0 0" />
                <geometry>
                    <mesh filename="package://gen3_lite_description/meshes/forearm_link.STL" />
                </geometry>
            </collision>
        </link>
        <joint name="${prefix}joint_3" type="revolute">
            <origin rpy="-3.1416 0 0" xyz="0 0.28 0" />
            <parent link="${prefix}arm_link" />
            <child link="${prefix}forearm_link" />
            <axis xyz="0 0 1" />
            <limit lower="${min_joint_3_pos}" upper="${max_joint_3_pos}"
                    effort="${joint_3_effort}" velocity="${joint_3_vel}" />
        </joint>

        <link name="${prefix}lower_wrist_link">
            <inertial>
                <origin rpy="0 0 0" xyz="0.00575149 0.01000443 0.08719207" />
                <mass value="0.52693412" />
                <inertia
                    ixx="0.00069098" ixy="2.4E-07" ixz="0.00016483"
                    iyy="0.00078519" iyz="7.4E-07"
                    izz="0.00034115" />
            </inertial>
            <visual>
                <origin rpy="0 0 0" xyz="0 0 0" />
                <geometry>
                    <mesh filename="package://gen3_lite_description/meshes/lower_wrist_link.STL" />
                </geometry>
                <material name="gen3_lite_white" />
            </visual>
            <collision>
                <origin rpy="0 0 0" xyz="0 0 0" />
                <geometry>
                    <mesh filename="package://gen3_lite_description/meshes/lower_wrist_link.STL" />
                </geometry>
            </collision>
        </link>
        <joint name="${prefix}joint_4" type="revolute">
            <origin rpy="1.5708 0 0" xyz="0 -0.14 0.02" />
            <parent link="${prefix}forearm_link" />
            <child link="${prefix}lower_wrist_link" />
            <axis xyz="0 0 1" />
            <limit lower="${min_joint_4_pos}" upper="${max_joint_4_pos}"
                    effort="${joint_4_effort}" velocity="${joint_4_vel}" />
        </joint>

        <link name="${prefix}upper_wrist_link">
            <inertial>
                <origin rpy="0 0 0" xyz="0.08056517 0.00980409 0.01872799" />
                <mass value="0.58097325" />
                <inertia
                    ixx="0.00021268" ixy="5.21E-06" ixz="2.91E-06"
                    iyy="0.00106371" iyz="1.1E-07"
                    izz="0.00108465" />
            </inertial>
            <visual>
                <origin rpy="0 0 0" xyz="0 0 0" />
                <geometry>
                    <mesh filename="package://gen3_lite_description/meshes/upper_wrist_link.STL" />
                </geometry>
                <material name="gen3_lite_white" />
            </visual>
            <collision>
                <origin rpy="0 0 0" xyz="0 0 0" />
                <geometry>
                    <mesh filename="package://gen3_lite_description/meshes/upper_wrist_link.STL" />
                </geometry>
            </collision>
        </link>
        <joint name="${prefix}joint_5" type="revolute">
            <origin rpy="0 1.5708 0" xyz="0.0285 0 0.105" />
            <parent link="${prefix}lower_wrist_link" />
            <child link="${prefix}upper_wrist_link" />
            <axis xyz="0 0 1" />
            <limit lower="${min_joint_5_pos}" upper="${max_joint_5_pos}"
                    effort="${joint_5_effort}" velocity="${joint_5_vel}" />
        </joint>

        <link name="${prefix}end_effector_link">
            <inertial>
                <origin rpy="0 0 0" xyz="0 0 0" />
                <mass value="0.001" />
                <inertia
                    ixx="1e-6" ixy="0" ixz="0"
                    iyy="1e-6" iyz="0"
                    izz="1e-6" />
            </inertial>
        </link>
        <joint name="${prefix}joint_6" type="revolute">
            <origin rpy="0 -1.5708 0" xyz="-0.105 0 0.0285" />
            <parent link="${prefix}upper_wrist_link" />
            <child link="${prefix}end_effector_link" />
            <axis xyz="0 0 1" />
            <limit lower="${min_joint_6_pos}" upper="${max_joint_6_pos}"
                    effort="${joint_6_effort}" velocity="${joint_6_vel}" />
        </joint>

        <!-- Dummy Link for Gripper Attachment -->
        <link name="${prefix}dummy_link" />
        <joint name="${prefix}end_effector" type="fixed">
            <origin rpy="0 0 0" xyz="0 0 0" />
            <parent link="${prefix}end_effector_link" />
            <child link="${prefix}dummy_link" />
            <axis xyz="0 0 1" />
        </joint>

        <!-- Optional components -->
        <xacro:if value="${use_camera}">
            <xacro:include filename="$(find gen3_lite_description)/urdf/camera/support.urdf.xacro" />
            <xacro:camera_inferior_support parent="dummy_link" prefix="${prefix}">
                <origin rpy="0.0 0.0 ${M_PI/2}" xyz="0.0 0.0 0.018" />
            </xacro:camera_inferior_support>
            <xacro:camera_superior_support parent="dummy_link" prefix="${prefix}">
                <origin rpy="0.0 0.0 -${M_PI/2}" xyz="0.0 0.0 0.018" />
            </xacro:camera_superior_support>
            <!-- <xacro:include filename="$(find gen3_lite_description)/urdf/camera/_d435.urdf.xacro" />
            <xacro:sensor_d435 parent="dummy_link" prefix="${prefix}" name="camera_1" add_plug="false">
                <origin rpy="${M_PI} -${M_PI/2} 0.0" xyz="0.045 0.0 0.018" />
            </xacro:sensor_d435> -->
            <xacro:include filename="$(find gen3_lite_description)/urdf/camera/_d435.urdf.xacro" />
            <xacro:sensor_d435 parent="camera_support_cylinder_link" prefix="${prefix}" name="camera_1" add_plug="false">
                <origin rpy="0.0 -${M_PI/2} -${M_PI/2}" xyz="0.0 0.010 0.0" />
            </xacro:sensor_d435>
        </xacro:if>

        <xacro:if value="${sim_gazebo}">
            <xacro:include filename="$(find gen3_lite_description)/urdf/gz/gen3_lite.gazebo.xacro" />
            <xacro:gen3_lite_gazebo parent="${parent}" prefix="${prefix}" use_camera="${use_camera}" />
        </xacro:if>

        <xacro:include filename="$(find gen3_lite_description)/urdf/ros2_control/gen3_lite_ros2_control.xacro" />
        <xacro:gen3_lite_ros2_control prefix="${prefix}" sim_gazebo="${sim_gazebo}" gripper="${gripper}" />

        <xacro:if value="${not gripper}">
            <link name="${prefix}tool_frame" />
            <joint name="${prefix}tool_frame_joint" type="fixed">
                <origin rpy="0 0 0" xyz="0 0 0" />
                <parent link="${prefix}${last_arm_link}" />
                <child link="${prefix}tool_frame" />
                <axis xyz="0 0 0" />
            </joint>
        </xacro:if>

    </xacro:macro>

</robot>